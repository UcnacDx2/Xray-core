---
title: 测试在 CI 中出现 “use of closed network connection” 日志导致作业失败 — 修复并忽略关闭连接时的预期错误
---

## 描述
在 GitHub Actions 运行（详见 workflow job: https://github.com/UcnacDx2/Xray-core/actions/runs/19670612176/job/56338254228，代码快照ref: 1a4c2c79275786fe78cab7bba788eb206b4b4bd4）中，多个单元测试在服务关闭阶段产生大量类似如下的错误日志：
- "Failed accept TCP connection: accept tcp 127.0.0.1:xxxx: use of closed network connection"
- "Failed to read from UDP: read udp 127.0.0.1:xxxxx: use of closed network connection"
- "io: read/write on closed pipe"
这些日志多数发生在服务器主动关闭期间（测试 teardown），属于已知的 benign race（连接尚在处理但 socket 已关闭）。尽管单个测试显示 PASS，但整个 job 最终以 exit code 1 结束，CI 判定为失败。

## 目标
修复测试文件/测试辅助库，使得在服务正常关闭情境下不将“use of closed network connection”类错误视为测试失败；仅在真正异常情况下才触发失败。

## 复现步骤
1. 在本仓库执行 `go test ./...` 或通过 GitHub Actions 的 Test workflow（.github/workflows/test.yml）。
2. 观察测试 teardown 阶段打印上述错误，并导致作业最终返回非 0 退出码。

## 期望行为
服务 teardown 中因连接关闭造成的这些错误应视为可忽略正常现象，不应使 CI 失败。

## 定位（建议修改目录）
- testing/scenarios/*
- testing/servers/*
- transport/internet/*（如 splithttp, websocket 等）

## 建议修复方案
1. 在 accept/read/write/UDP read 错误处理时，区分“真实错误”与“连接已关闭”，使用 errors.Is(err, net.ErrClosed) 或匹配 'use of closed network connection' 作兼容。
2. 测试 helper 遇到关闭时错误仅 Log 不 Fatal。

## 示例代码片段
```go
if err != nil {
    if errors.Is(err, net.ErrClosed) || strings.Contains(err.Error(), "use of closed network connection") {
        return
    }
    // 其他错误按原逻辑处理
}
```

## 其它
修复分支已预创建：fakedesync-with-broken-test，建议在此分支上提交修复。